---
title: "Assessing the Koriabo pottery as an archaeological correlate of the Cariban-language expansions across the northern Amazon"
author: "Bruno Barreto"
date: "2023-03-28"
output: 
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, cache = FALSE, autodep = TRUE}
knitr::opts_chunk$set(echo = TRUE, autodep = TRUE)
load("data/data2.Rdata")
```

## Introduction

From AD 1200 to 1500, a pottery style called Koriabo appeared in most parts of
Northern Amazonia, including Guianas and the Lower Amazon. Such ceramics were
also present by the time of first colonial enterprises in the Caribbean, in sites dated from
the 16th and 17th centuries in Lesser Antilles, which are understood as related to
Kalinago peoples. Despite its distribution over a vast territory, the homogeneity of
decorative forms and vessel shapes is a striking characteristic of such ceramics, whose
most of the radiocarbon datings range from AD 1000 to 1500 in Amazonia. Some have
raised that such ceramics would be understood as one of the archaeological correlates of
the Carib-speaking peoples, in reason of its presence matched with places historically
occupied by them. On the other hand, others agree that their phenomenon is more
related to the formation of long-distance exchange networks. My hypothesis is that
Koriabo could be explained by means of a two-folded process, including the making
and reproduction of exchange networks and demic diffusion, translated in substantial
population movements. Such migrations probably had a rapid rhythm and created more
homogeneous patterns of archaeological visibility. One of the archaeological models for
Carib-languages expansion points out that the last expansion step initiated by AD 1000,
when population growth and the strengthening of exchange networks led to a diasporic
movement to the regions known at the time of colonial encounters. The purpose of this
paper is to discuss such ideas by the means of GIS and time-series modeling of
radiocarbon dates.

## Radiocarbon modeling
#### Loading Libraries
```{r Loading Libraries, message = FALSE}
library(tidyverse)
library(rcarbon)
library(rnaturalearth)
library(rnaturalearthhires)
library(sf)
library(sp)
```


#### Preparing the data
```{r raw_data, cache = TRUE, cache.extra = file.info("data_raw/c14dates.csv")}
# Creation and management of data frame for all radiocarbon dates
c14dates <- read.csv("data_raw/c14dates.csv")                # reading the CSV file with radiocarbon dates
c14dates$site <- factor(c14dates$site)                       # converting the column 'dates' in a factor
c14dates$country_state <- factor(c14dates$country_state)     # converting the column 'country_state' in a factor
c14dates$region <- factor(c14dates$region)                   # converting the column 'region' in a factor 
c14dates$culture <- factor(c14dates$culture)                 # converting the column 'culture' in a factor

```

#### Calibrating ^14^C Dates
```{r calibration, message = FALSE, results = 'hide', cache = TRUE, dependson = "raw_data"}
# Calibrating the radiocarbon dates

c14koriabo <- subset(c14dates, culture == "1 - Koriabo") # Extracting a Koriabo subset of Radiocaron dates

c14calibration_koriabo <- calibrate(
  x = c14koriabo$age,          # The radiocarbon age for each of the 135 radiocarbon dates
  errors = c14koriabo$std,     # Standard deviation of each radiocarbon date
  method = "mixed",            # Method for mixing the radiocarbon atmospheric curves
  mixed.curves = TRUE,         # Enabling the argument for mixing the atmospheric curves
  intcal20 = intcal20(),       # Calling the IntCal20 atmospheric curve for Northern Hemisphere
  shcal20 = shcal20(),         # Calling the ShCal20 atmospheric curve for Southern Hemisphere
  normalised = FALSE           # The data are not normalized in order to avoid false peaks in the SPD model
)

# Creating a Time Range object for running the analyses
timeRange <- c(
  2300,  # Starting point on 2300 BP (BC 300)
  300    # Ending point on 300 BP (AD 1700)
) 
```

### First Modeling: Summed Probability Distribution (SPD) and Growth Model
#### Step 1 - The SPD Model
```{r SPD_model, results = 'hide', cache = TRUE}
spd_koriabo <- spd(                  # Generation fo the SPD of SantarÃ©m radiocarbon dates
  c14calibration_koriabo,            # Using the Koriabo radiocarbon calibrations
  timeRange = timeRange              # Time Range from 2300 BP to 300 BP 
)
```

```{r plot_SPD, echo = FALSE, fig.align = 'center'}
plot(
  spd_koriabo,            #SPD object for all Radiocarbon dates
  calendar = 'BCAD',      #Plot the SPD Model in BC/AD years
  main = "Summed Probability Distribution of Koriabo radiocarbon dates" #Label
  )

plot(                     #Plotting the smoothing line with a bin value of 200 years
  spd_koriabo,           #SPD object for all radiocarbon dates
  calendar = 'BCAD',      #Calendar in BC/AD years
  runm = 200,             #Smoothed distribution with a binning of 200 years
  add = TRUE,             #Add the line
  type = "simple",        #Simple line
  col = "red",            #Line colour = Red
  lwd = 2,                #Line Thickness = 2
  lty = 2
)
```

#### Step 2 - Binning the SPD Model
```{r binning_SPD, results = 'hide'}
bins_c14calibration <- binPrep(    # Generation of an object for the bins
  sites = c14koriabo$site,     # Column for archaeological sites
  ages = c14koriabo$age,       # Column with the radiocarbon age values
  h = 100                      # Parameter for binning between an interval of 100 years
  )

binned_spd_koriabo <- spd(        # Generation of the final binned SPD model 
  c14calibration_koriabo,          # Object with all the unnormalised radiocarbon dates
  bins = bins_c14calibration,      # Object with the bins values for binning the model
  timeRange = timeRange,           # Time Range of the analysis frmo 2300 to 300 BP
)
```
```{r plot_binned_SPD, echo = FALSE, fig.align = 'center'}
plot(
  binned_spd_koriabo,    #SPD object for all Radiocarbon dates
  calendar = 'BCAD',      #Plot the SPD Model in BC/AD years
  main = "Binned Summed Probability Distribution (SPD)" # Plot Title
)

plot(                     #Plotting the smoothing line with a bin value of 200 years
  binned_spd_koriabo,    #SPD object for all radiocarbon dates
  calendar = 'BCAD',      #Calendar in BC/AD years
  runm = 200,             #Smoothed distribution with a binning of 200 years
  add = TRUE,             #Add the line
  type = "simple",        #Simple line
  col = "red",            #Line colour = Red
  lwd = 2,                #Line Thickness = 2
  lty = 2
)
```
```{r plot_binsense, echo = FALSE, results = 'hide', fig.align='center', out.width = '100%'}
binsense(
  x = c14calibration_koriabo,
  y = c14koriabo$site,
  h = seq(0, 300, 100),
  timeRange = timeRange,
)
```



#### Step 3 - Kernel Density Estimation Model (KDE)

```{r KDE, results = 'hide'}
C14randates <- sampleDates(
  c14calibration_koriabo,
  bins = bins_c14calibration,
  nsim = 100,
  verbose = FALSE
)

c14koriabo_ckde <- ckde(
  C14randates,
  timeRange = timeRange,
  bw = 100
)
```

```{r plot_kde, echo = FALSE, fig.align = 'center'}
plot(
  c14koriabo_ckde,
  type = 'multiline',
  main = "Kernel Density Estimation (KDE) for Koriabo Pottery"
)
```

#### Step 4 - Exponential Growth Model
```{r exp_model, results = FALSE}
c14koriabo_expnull <- modelTest(
  c14calibration_koriabo,
  errors = c14koriabo$std,
  bins = bins_c14calibration,
  nsim = 100,
  timeRange = c(2500,0),
  model = "exponential",
  runm = 100
)
```

```{r plot exp_model, echo = FALSE, warning = FALSE, fig.align = 'center'}
plot(c14koriabo_expnull,
     calendar = 'BCAD',
     main = "Exponential Growth Model (Koriabo)"
)
```


#### Step 5 - Permutation Test by Region
```{r perm_test, results = FALSE}
permTest_region <- permTest(
  x = c14calibration_koriabo,
  marks = c14koriabo$region,
  timeRange = c(3000,100),
  bins = bins_c14calibration,
  nsim = 100,
  runm = 50
)

```

```{r stackCalSPD}
permTest_region_stack_spd <- stackspd(
  x = c14calibration_koriabo,
  group = c14koriabo$country_state,
  timeRange = c(3000,0),
  bins = bins_c14calibration,
  runm = 50,
  verbose = FALSE
)
```




```{r plot_permtest, echo = FALSE, out.width = '100%'}
par(mfrow = c(2,2))
plot(permTest_region, focalm = 1, calendar = 'BCAD', main = "Western Guiana")
plot(permTest_region, focalm = 2, calendar = 'BCAD', main = "Suriname / French Guiana")
plot(permTest_region, focalm = 3, calendar = 'BCAD', main = "Amapa-Estuary")
plot(permTest_region, focalm = 4, calendar = 'BCAD', main = "Xingu-Iriri Rivers")

```
```{r plot stack_spd, echo = FALSE, out.width = '100%'}
par(mfrow=c(1,1))
plot(permTest_region_stack_spd, type = 'multipanel',  calendar = 'BCAD')
```

#### Step 6 - Spatial Permutation Test
```{r spatial_perm, results = FALSE}
load("data/data2.RData")
allsites <- unique(data.frame(id = c14koriabo$site, lat = c14koriabo$lat, long = c14koriabo$long))

allsites <- st_as_sf(allsites, coords = c('long','lat'), crs = 4326)

breaks <- seq(1100,500,-100)

timerange_spatialperm <- c(1100,500)

koriabo_spd <- spd(
  x = c14calibration_koriabo,
  bins = bins_c14calibration,
  timeRange = timerange_spatialperm
)

spatial_perm <- sptest(
  calDates = c14calibration_koriabo,
  bins = bins_c14calibration,
  timeRange = timerange_spatialperm,
  locations = allsites,
  locations.id.col = 'id',
  h = 100,
  kernel = 'gaussian',
  permute = 'locations',
  nsim = 100,
  breaks = breaks,
  ncores = 1,
  verbose = FALSE
)

world <- ne_countries(scale = 'medium', type = 'map_units', returnclass = 'sf')

xrange <- st_bbox(allsites)[c(1,3)]
yrange <- st_bbox(allsites)[c(2,4)]

```


```{r plot_GRates, echo = FALSE, out.width= '100%'}
plot(spd2rc(carib_spd, breaks = breaks))
```

```{r plot_spatialTest, echo = FALSE, out.width= '100%'}

water <- read_sf("data_raw/sa_water.shp")

#Plot XX - Spatial Permutation Test
par(mar=c(2,2,2,2), mfrow=c(2,1))

#Plot1
plot(world$geometry,
     col = "antiquewhite3",
     border = "gray20",
     xlim = xrange,
     ylim = yrange,
     main = "Growth Rate (from 1100-1000 BP to 900-800 BP)"
)

plot(
  water$geometry,
  col = "lightblue4",
  border = "lightblue4",
  add = TRUE
)


plot(spatial_perm,
     index = 2,
     option = "raw",
     add = TRUE,
     breakRange = c(-0.005,0.005),
     breakLength = 7,
     rd = 5,
     legend = TRUE,
     legSize = 0.7,
     baseSize = 1.7,
     location = "topright")

#Plot2
plot(world$geometry,
     col = "antiquewhite3",
     border = "gray20",
     xlim = xrange,
     ylim = yrange,
     main = "Growth Rate (from 900-800 BP to 700-600 BP)"
)

plot(
  water$geometry,
  col = "lightblue4",
  border = "lightblue4",
  add = TRUE
)

plot(spatial_perm,
     index = 3,
     option = "raw",
     add = TRUE,
     breakRange = c(-0.005,0.005),
     breakLength = 7,
     rd = 5,
     legend = TRUE,
     legSize = 0.7,
     baseSize = 1.7,
     location = "topright")



```

